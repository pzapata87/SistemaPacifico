@model SistemaPacifico.Models.ComisionModel

@{
    ViewBag.Title = "Edit";
}

<div class="container">
    <div class="page-header">
    </div>
    @using (Html.BeginForm("CrearComision", "Comision", FormMethod.Post))
    {
        <table width="100%">
            <tr>
                <td>&nbsp;</td>
                <td>Nombre Comisión</td>
                <td>:</td>
                <td>
                    @Html.TextBoxFor(model => model.NombreComision, new { @maxlength= 50, @class = "form-control" }) 
                </td>
                <td>&nbsp;</td>
                <td>Canal Venta</td>
                <td>:</td>
                <td>
                    @Html.DropDownList("ddlCanalVenta", new SelectList(Model.CanalVentList, "Valor", "Nombre"), new {@class="btn btn-default", @style="width: 170px"})
                </td>
                <td>&nbsp;</td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td>Campaña</td>
                <td>:</td>
                <td>
                    @Html.DropDownList("ddlCampania", new SelectList(Model.CampaniaList, "Valor", "Nombre"), new {@class="btn btn-default", @style="width: 170px"})
                </td>
                <td>&nbsp;</td>
                <td>Cargo Comisionista</td>
                <td>:</td>
                <td>
                    @Html.DropDownList("ddlCargo", new SelectList(Model.CargoList, "Valor", "Nombre"), new {@class="btn btn-default", @style="width: 170px"})
                </td>
                <td>&nbsp;</td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td>Requisitos</td>
                <td>:</td>
                <td colspan="5">
                    @Html.DropDownList("ddlRequisito", new SelectList(Model.RequisitoList, "Valor", "Nombre"), new {@class="btn btn-default", @style="width: 200px"})
                </td>
            </tr>
            <tr>
                <td colspan="3"></td>
                <td>
                    <br />
                    <input id="txtMinimo" maxlength="3" class="form-control" style="width: 80%" placeholder="Monto Mínimo" />
                </td>
                <td>
                    <br />
                    <input id="txtMaximo" maxlength="3" class="form-control" style="width: 80%" placeholder="Monto Máximo"/>
                </td>
                <td>
                    <br />
                    <input id="txtComision" maxlength="3" class="form-control" style="width: 80%" placeholder="Monto Comisión"/>
                </td>
                <td colspan="3"><button id="btnAgregar" type="button" class="btn">+</button></td>
            </tr>
            <tr>
                <td colspan="3"></td>
                <td colspan="3">
                    <br />
                    <div data-bind='simpleGrid: gridViewModel'> </div>
                </td>
                <td colspan="3"></td>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td colspan="7" align="center">
                    <button id="btnGrabar" type="submit" class="btn">Grabar</button>
                    <button type="reset" class="btn" onclick=" javascript:window.history.back(); ">Cancelar</button>
                </td>
                <td>&nbsp;</td>
            </tr>
        </table>
    }
</div>

<script type="text/javascript">
    var initialData = [];

    var PagedGridModel = function (items) {
        this.items = ko.observableArray(items);

        this.addItem = function (montoMinimo, montoMaximo, montoComision) {
            this.items.push({ Minimo: montoMinimo, Maximo: montoMaximo, Cantidad: montoComision });
        };

        this.clearData = function () {
            this.items.removeAll();
        };

        this.sortByName = function () {
            this.items.sort(function (a, b) {
                return a.name < b.name ? -1 : 1;
            });
        };

        this.jumpToFirstPage = function () {
            this.gridViewModel.currentPageIndex(0);
        };

        this.gridViewModel = new ko.simpleGrid.viewModel({
            data: this.items,
            columns: [
                { headerText: "Monto Mínimo", rowText: "Minimo" },
                { headerText: "Monto Máximo", rowText: "Maximo" },
                { headerText: "Monto Comisión", rowText: "Cantidad" }
            ],
            pageSize: 100
        });
    };

    var modeloGrilla = new PagedGridModel(initialData);
    ko.applyBindings(modeloGrilla);

    $(document).ready(function () {
        $("#ddlRequisito").multiselect({
            checkAllText: 'Marcar Todas',
            uncheckAllText: 'Desmarque Todas',
            noneSelectedText: 'Seleccione',
            selectedText: 'Seleccionados',
            height: 200
        });
        
        $('#btnGrabar').click(function () {
            Grabar();
        });
        
        $('#btnAgregar').click(function () {
            modeloGrilla.addItem($("#txtMinimo").val(), $("#txtMaximo").val(), $("#txtComision").val());
        });
    });

    function Grabar() {
        debugger;
        var comision = {};
        comision.NombreComision = $("#NombreComision").val();
        comision.CampaniaId = $("#ddlCampania").val();
        comision.CanalVentaId = $("#ddlCanalVenta").val();
        comision.CargoId = $("#ddlCargo").val();
        comision.RequisitoListSelected = [];
        comision.RangoList = [];
        
        var list = $("#ddlRequisito").multiselect("widget").find("input:checked");
        for (var i = 0; i < list.length; i++) {
            comision.RequisitoListSelected.push(list[i].value);
        }

        for (i = 0; i < initialData.length; i++) {
            comision.RangoList.push({
                Minimo: initialData[i].Minimo,
                Maximo: initialData[i].Maximo,
                Cantidad: initialData[i].Cantidad
            });
        }
        
        var request = $.ajax({
            url: '@Url.Action("CrearComision", "Comision")',
            data: JSON.stringify(comision),
            contentType: 'application/json',
            dataType: 'json',
            type: 'post'
        });
        
        request.done(function (data) {
            //$("#labelSuccess").show();
            window.location.href = data;
        });
        request.fail(function (jqXHR, textStatus) {
            alert("Request failed: " + textStatus);
        });
    }
</script>
